# Neovim 初心者向け演習

この演習は、本 Neovim 設定の主要機能を段階的に習得するためのハンズオン教材です。
各演習には **目標**、**手順**、**確認ポイント** があります。順番に進めてください。

**前提:** `install.sh` によるセットアップが完了していること。

**リーダーキー:** `,`（カンマ）

---

## 演習 0: 練習用ファイルの準備

ターミナルで以下を実行し、練習用ディレクトリを作成します。

```bash
mkdir -p ~/nvim_exercise
cd ~/nvim_exercise
git init

cat << 'EOF' > hello.py
def greet(name):
    message = "Hello, " + name + "!"
    print(message)
    return message

def add(a, b):
    result = a + b
    return result

def multiply(x, y):
    product = x * y
    return product

# TODO: subtract 関数を実装する
# FIX: greet 関数で空の名前を処理する

names = ["Alice", "Bob", "Charlie"]
for name in names:
    greet(name)

print(add(3, 5))
print(multiply(4, 7))
EOF

cat << 'EOF' > notes.md
# プロジェクトメモ

## やることリスト

- [x] hello.py を作成
- [ ] テストを書く
- [ ] ドキュメントを整備

## メモ

これは **Neovim 演習用** のファイルです。
`コード` を書く練習をしましょう。

| 機能       | 状態   |
|------------|--------|
| 基本移動   | 未着手 |
| 検索       | 未着手 |
| LSP        | 未着手 |

> 引用ブロックの例です。
> 複数行にまたがることもできます。
EOF

cat << 'EOF' > data.json
{
  "users": [
    {"id": 1, "name": "Alice", "role": "admin"},
    {"id": 2, "name": "Bob", "role": "user"},
    {"id": 3, "name": "Charlie", "role": "user"}
  ],
  "settings": {
    "theme": "dark",
    "language": "ja",
    "notifications": true
  }
}
EOF

cat << 'EOF' > config.yaml
server:
  host: localhost
  port: 8080
  debug: true

database:
  host: localhost
  port: 5432
  name: myapp
  user: admin

logging:
  level: info
  format: json
EOF

cat << 'EOF' > style.lua
local M = {}

function M.setup()
  local config = {
    theme = "tokyonight",
    transparent = false,
    styles = {
      comments = { italic = true },
      keywords = { bold = true },
    },
  }
  return config
end

function M.get_colors()
  return {
    red = "#ff0000",
    green = "#00ff00",
    blue = "#0000ff",
  }
end

return M
EOF

git add -A && git commit -m "演習用の初期コミット"
```

準備ができたら Neovim を起動します:

```bash
cd ~/nvim_exercise
nvim hello.py
```

---

## レベル 1: 基本操作 — 移動とモード切替

### 演習 1.1: モードの切り替え

**目標:** ノーマル・インサート・ビジュアル・コマンドの4つのモードを自在に切り替える。

1. `hello.py` を開いた状態（ノーマルモード）を確認する
2. `Space` を押してインサートモードに入る（この設定独自のキー）
3. 適当な文字を入力する
4. `Esc` を押してノーマルモードに戻る
5. `u` を押して変更を元に戻す（アンドゥ）
6. `v` を押してビジュアルモードに入り、`hjkl` でテキストを選択する
7. `Esc` でノーマルモードに戻る
8. `:` を押してコマンドモードに入り、`:q!` で保存せず終了する

**確認ポイント:**
- [ ] 画面左下のモード表示が切り替わることを確認した
- [ ] `Space` でインサートモードに入れた
- [ ] `u` でアンドゥできた

### 演習 1.2: カーソル移動

**目標:** `hjkl` と拡張移動キーに慣れる。

`nvim hello.py` で再度開き、以下を試す:

| 操作 | キー | やること |
|------|------|---------|
| 基本移動 | `h` `j` `k` `l` | 左・下・上・右にカーソルを動かす |
| 行頭へ | `Ctrl+h` | どの位置からでも行頭に移動する |
| 行末へ | `Ctrl+l` | どの位置からでも行末に移動する |
| 5行下へ | `Ctrl+j` | 素早く下に移動する |
| 5行上へ | `Ctrl+k` | 素早く上に移動する |
| 次の単語へ | `w` | 次の単語の先頭へ |
| 前の単語へ | `b` | 前の単語の先頭へ |
| ファイル先頭へ | `gg` | ファイルの一番上へ |
| ファイル末尾へ | `G` | ファイルの一番下へ |
| 指定行へ | `10G` | 10行目へジャンプ |

**練習:** ファイルの最終行（`G`）に移動してから、先頭（`gg`）に戻り、10行目（`10G`）にジャンプする。次に `Ctrl+j` を3回押して15行下に移動し、`Ctrl+h` で行頭に移動する。

**確認ポイント:**
- [ ] `Ctrl+h` / `Ctrl+l` で行頭・行末に瞬時に移動できた
- [ ] `Ctrl+j` / `Ctrl+k` で高速に上下移動できた
- [ ] `gg` / `G` でファイルの先頭・末尾に移動できた

### 演習 1.3: 基本的な編集

**目標:** テキストの挿入・削除・コピー・貼り付けの基本操作を覚える。

1. `G` でファイル末尾に移動する
2. `o` で下に新しい行を作りインサートモードに入る
3. `print("演習完了！")` と入力する
4. `Esc` でノーマルモードに戻る
5. `yy` で現在行をコピー（ヤンク）する
6. `p` で下に貼り付ける
7. `dd` で現在行を削除する
8. `u` を2回押して元に戻す

**コマンドモードでの貼り付け:**

9. `yy` で適当な行をヤンクする
10. `:` でコマンドモードに入る
11. `Ctrl+r` `"` を押す → 直前にヤンクした内容がコマンドラインに貼り付けられる
12. `Esc` でコマンドモードを抜ける

*`Ctrl+r` `"` はコマンドモードやインサートモードで無名レジスタの内容を貼り付けるキーです。検索（`/`）の入力時にも使えます。*

**`.`（ドット）コマンド — 直前の操作を繰り返す:**

13. `hello.py` の任意の行で `dd` を押して行を削除する
14. 別の行に移動して `.` を押す → 同じ削除操作が繰り返される
15. `u` で元に戻す
16. `ciwtest` `Esc` で単語を `test` に変更する
17. 別の単語に移動して `.` を押す → その単語も `test` に変更される
18. `u` ですべて元に戻す

*`.` は直前の編集操作（削除、変更、挿入など）を1キーで繰り返す強力なコマンドです。同じ操作を複数箇所に適用するときに便利です。*

**確認ポイント:**
- [ ] `o` で新しい行に入力できた
- [ ] `yy` → `p` でコピー＆ペーストできた
- [ ] `dd` で行を削除し、`u` で復元できた
- [ ] `Ctrl+r` `"` でコマンドラインにヤンク内容を貼り付けられた
- [ ] `.` で直前の操作を繰り返せた

---

## レベル 2: ウィンドウ・タブ・ファイル操作

### 演習 2.1: ウィンドウ分割

**目標:** 複数ファイルを同時に表示して作業する。

1. `hello.py` を開いている状態で `:vsp notes.md` を実行する（縦分割）
2. `Shift+l` で右のウィンドウ（notes.md）に移動する
3. `Shift+h` で左のウィンドウ（hello.py）に戻る
4. `:sp config.yaml` を実行する（横分割）
5. `Shift+j` で下のウィンドウに移動する
6. `Shift+k` で上のウィンドウに戻る
7. `Shift+Right` を数回押してウィンドウ幅を広げる
8. `:only` で現在のウィンドウ以外をすべて閉じる

**確認ポイント:**
- [ ] `Shift+h/j/k/l` でウィンドウ間を自在に移動できた
- [ ] `Shift+矢印キー` でウィンドウサイズを変更できた

### 演習 2.2: タブ操作

**目標:** タブを使って複数ファイルを管理する。

1. `,tn` で新しいタブを開く
2. `Tab` で次のタブ（hello.py）に切り替える
3. `Shift+Tab` で前のタブに戻る
4. `,tc` で現在のタブを閉じる

**確認ポイント:**
- [ ] `Tab` / `Shift+Tab` でタブ間を移動できた
- [ ] `,tn` / `,tc` でタブの作成・削除ができた

### 演習 2.3: NERDTree（ファイルエクスプローラー）

**目標:** ファイルツリーを使ってファイルの閲覧・作成・コピー・移動・ブックマークを行う。

1. `Ctrl+n` で NERDTree を開く
2. `j` / `k` で `notes.md` に移動し、`Enter` または `Ctrl+o` で開く
3. `Ctrl+c` で現在編集中のファイルを NERDTree 上で表示する（そのファイルのディレクトリが作業ディレクトリに設定される）

**ファイル・ディレクトリの作成:**

4. NERDTree 内で `m` を押す → ファイル操作メニューが表示される
5. `a` を選び `test.txt` と入力して新規ファイルを作成する
6. もう一度 `m` → `a` を選び `subdir/` と入力する（末尾に `/` を付けるとディレクトリが作成される）

**コピーと移動:**

7. `test.txt` にカーソルを置き `m` → `c`（コピー）を選ぶ → コピー先のパスを入力する（例: `test_copy.txt`）
8. `test_copy.txt` にカーソルを置き `m` → `m`（移動/名前変更）を選ぶ → 移動先のパスを入力する（例: `subdir/test_copy.txt`）
9. `Shift+r` で NERDTree を更新し、ファイルが移動されたことを確認する

**ブックマーク:**

10. よく使うディレクトリやファイルにカーソルを置き `:Bookmark 練習用` と入力する → ブックマークが登録される
11. `B` を押す → ブックマーク一覧が表示される
12. ブックマーク上で `Enter` を押してジャンプする
13. 不要なブックマーク上で `D` を押して削除する
14. `Ctrl+n` で NERDTree を閉じる

**確認ポイント:**
- [ ] `Ctrl+n` で NERDTree を開閉できた
- [ ] NERDTree からファイルを開けた
- [ ] `m` → `a` でファイルとディレクトリ（末尾 `/`）を作成できた
- [ ] `m` → `c` でファイルをコピーできた
- [ ] `m` → `m` でファイルを移動（名前変更）できた
- [ ] `:Bookmark` でブックマークを登録し、`B` で一覧表示できた

---

## レベル 3: 検索

### 演習 3.1: バッファ内検索

**目標:** ファイル内のテキストを素早く見つける。

1. `hello.py` を開く
2. `/greet` と入力して `Enter` — `greet` がハイライトされる
3. `n` で次の一致箇所に移動する
4. `N` で前の一致箇所に戻る
5. カーソルを `name` の上に置いてから `*` を押す → その単語が検索される
6. `Esc` で検索ハイライトを消す

**確認ポイント:**
- [ ] `/パターン` で検索でき、`n` / `N` で前後に移動できた
- [ ] `*` でカーソル下の単語を検索できた
- [ ] `Esc` でハイライトを消せた

### 演習 3.2: Ferret（プロジェクト全体の検索・置換）

**目標:** プロジェクト全体のテキストを検索し、一括で置換する。

1. `:Ack greet` を実行 → QuickFix リストに検索結果が表示される
2. QuickFix リスト内で `j` / `k` で結果を選択し、`Enter` で該当箇所にジャンプする
3. `:Acks /greet/welcome/` を実行 → すべての `greet` が `welcome` に置換される
4. `:Ack welcome` で置換結果を確認する
5. `u` で変更を元に戻す（各バッファで個別に）

**確認ポイント:**
- [ ] `:Ack` でプロジェクト全体を検索できた
- [ ] `:Acks` で一括置換ができた

---

## レベル 4: テキスト編集（中級）

### 演習 4.1: テキストオブジェクト

**目標:** `i`（内側）/ `a`（外側）を使って効率的に編集する。

`hello.py` を開き、以下を順番に試す:

1. `greet` 関数内の `"Hello, "` にカーソルを移動する
2. `ci"` を押す → ダブルクォート内のテキストが削除されインサートモードに入る
3. `Welcome, ` と入力して `Esc` で戻る
4. `u` で元に戻す
5. `greet(name)` の `name` にカーソルを移動する
6. `ci)` を押す → 括弧内が削除されインサートモードに入る
7. `user` と入力して `Esc` で戻る
8. `u` で元に戻す
9. `vi"` で `""` 内のテキストをビジュアル選択してみる
10. `Esc` で選択を解除する

**応用:** `data.json` を開いて以下を試す:
- `"Alice"` にカーソルを置き `yi"` → 名前だけがヤンクされる
- `{"id": 1, ...}` の `{` にカーソルを置き `vi{` → オブジェクト内が選択される
- `[` にカーソルを置き `va[` → 配列全体が選択される

**確認ポイント:**
- [ ] `ci"` で引用符内を変更できた
- [ ] `ci)` で括弧内を変更できた
- [ ] `vi{` で波括弧内を選択できた

### 演習 4.2: ヤンクを使った置換

**目標:** この設定独自のコピー＆置換操作を使う。

1. `hello.py` で `result` にカーソルを置き `yiw` でヤンクする
2. `product` にカーソルを移動する
3. `ciy` を押す → `product` が `result` に置換される
4. `u` で元に戻す
5. 別の方法: `product` にカーソルを置き `Ctrl+p` を押す → 同様にヤンク内容で置換される

**確認ポイント:**
- [ ] `ciy` でヤンクしたテキストで単語を置換できた
- [ ] `Ctrl+p` でも同じ操作ができた

### 演習 4.3: 行の移動（mini.move）

**目標:** 行や選択範囲を自在に上下移動する。

1. `hello.py` の `def add` の行にカーソルを置く
2. `Alt+j` を数回押して行を下に移動する
3. `Alt+k` で上に戻す
4. `V` で行を選択し、`j` で複数行に広げる
5. `Alt+j` で選択した複数行をまとめて下に移動する
6. `u` で元に戻す

**確認ポイント:**
- [ ] `Alt+j` / `Alt+k` で行を上下に移動できた
- [ ] ビジュアルモードで選択した複数行もまとめて移動できた

### 演習 4.4: コメントの切り替え（mini.comment）

**目標:** コードのコメントアウト・解除を素早く行う。

1. `hello.py` の `print(message)` の行にカーソルを置く
2. `gcc` を押す → 行がコメントアウトされる（`# print(message)`）
3. もう一度 `gcc` を押す → コメントが解除される
4. `V` で3行を選択する
5. `gc` を押す → 選択した3行がまとめてコメントアウトされる
6. `u` で元に戻す

**確認ポイント:**
- [ ] `gcc` で1行のコメントを切り替えられた
- [ ] ビジュアルモードで `gc` を使い複数行をまとめてコメント切り替えできた

---

## レベル 5: LSP（コード補助機能）

### 演習 5.1: コード補完

**目標:** 補完機能を使ってコードを素早く書く。

1. `hello.py` の末尾に移動する
2. `o` で新しい行を作りインサートモードに入る
3. `pri` と入力する → 自動的に補完候補が表示される
4. `Ctrl+n` / `Ctrl+p` で候補を上下に選択する
5. `Enter` で候補を確定する
6. `Esc` でノーマルモードに戻り、`u` で元に戻す

**確認ポイント:**
- [ ] 入力中に自動で補完候補が表示された
- [ ] `Ctrl+n` / `Ctrl+p` で候補を選び、`Enter` で確定できた

### 演習 5.2: 定義ジャンプ（gutentags / ctags）

**目標:** タグを使ったコードナビゲーション機能を使う。

1. `hello.py` の末尾にある `greet(name)` の呼び出し箇所にカーソルを置く
2. `Ctrl+]` を押す → タグを使って `greet` 関数の定義にジャンプする
3. `Ctrl+t` で元の位置に戻る
4. `:ts greet` を実行 → タグ候補の一覧から選択してジャンプする

**確認ポイント:**
- [ ] `Ctrl+]` でタグジャンプできた
- [ ] `Ctrl+t` で元の位置に戻れた
- [ ] `:ts` でタグ候補の一覧を確認できた

---

## レベル 6: ターミナルと便利機能

### 演習 6.1: 内蔵ターミナル

**目標:** Neovim 内でターミナルコマンドを実行する。

1. `F12` を押す → 分割ウィンドウでターミナルが開く
2. `ll` を実行してファイル一覧を確認する
3. `python3 hello.py` を実行してスクリプトの出力を確認する
4. `Esc` でターミナルモードを終了する
5. `Shift+k` で上のウィンドウ（エディタ）に戻る

**確認ポイント:**
- [ ] `F12` でターミナルを開けた
- [ ] ターミナルでコマンドを実行できた
- [ ] `Esc` でターミナルモードを抜けられた

### 演習 6.2: TODO コメントのハイライト

**目標:** TODO / FIX / NOTE コメントが自動でハイライトされることを確認する。

1. `hello.py` を開く
2. `# TODO:` と `# FIX:` のコメント行を見つける → 色付きでハイライトされている
3. 新しい行に `# NOTE: これはメモです` と入力する → NOTE もハイライトされる

**確認ポイント:**
- [ ] TODO / FIX / NOTE がそれぞれ異なる色でハイライトされた

---

## レベル 7: スニペット

### 演習 7.1: スニペットの展開

**目標:** スニペットを使って定型テキストを素早く入力する。

1. `:e test.md` で新しい Markdown ファイルを作成する
2. インサートモードで `chunk` と入力する
3. `Ctrl+s` を押す → コードチャンクのスニペットが展開される
4. プレースホルダに値を入力する
5. `Tab` で次のプレースホルダに移動する
6. `Ctrl+h` で前のプレースホルダに戻る

**利用可能なスニペット（グローバル）:**

| 入力 | 展開される内容 |
|------|---------------|
| `todo` | TODO アイテム（期日付き） |
| `fig` | 画像挿入タグ |
| `tab` | Markdown テーブル |
| `callout` | コールアウトブロック |
| `comment` | HTML コメント |
| `chunk` | コードチャンク |
| `yaml` | Quarto 用 YAML ヘッダ |

**確認ポイント:**
- [ ] `Ctrl+s` でスニペットが展開された
- [ ] `Tab` / `Ctrl+h` でプレースホルダ間を移動できた

### 演習 7.2: 新しいスニペットの作成

**目標:** 自分だけのスニペットを追加する。

スニペットファイルは `~/.config/nvim/snippets/global.json` にあります（VSCode 形式の JSON）。

1. ターミナルまたは Neovim で `~/.config/nvim/snippets/global.json` を開く
2. 既存のスニペットを参考に、以下のような新しいスニペットを末尾（`}` の前）に追加する:

```json
  "Python 関数テンプレート": {
    "prefix": "pyfunc",
    "body": [
      "def ${1:function_name}(${2:args}):",
      "\t\"\"\"${3:説明}\"\"\"",
      "\t${0:pass}"
    ],
    "description": "Python 関数のテンプレート"
  }
```

3. ファイルを保存する
4. `hello.py` を開き、インサートモードで `pyfunc` と入力する
5. `Ctrl+s` で展開する → 関数テンプレートが挿入される
6. `$1`（関数名）に値を入力し、`Tab` で `$2`（引数）→ `$3`（説明）→ `$0`（本体）と移動する

**スニペットの書式:**

| 記号 | 意味 |
|------|------|
| `$1`, `$2`, ... | プレースホルダ（Tab で順に移動） |
| `$0` | 最終カーソル位置 |
| `${1:デフォルト値}` | デフォルト値付きプレースホルダ |
| `\t` | タブ（インデント） |

**確認ポイント:**
- [ ] `global.json` に新しいスニペットを追加できた
- [ ] 追加したスニペットが `Ctrl+s` で展開された
- [ ] プレースホルダ間を `Tab` で移動できた

---

## キーマップ早見表

| 操作 | キー |
|------|------|
| **カーソル移動** | |
| 行頭 / 行末 | `Ctrl+h` / `Ctrl+l` |
| 5行上 / 5行下 | `Ctrl+k` / `Ctrl+j` |
| ファイル先頭 / 末尾 | `gg` / `G` |
| **ウィンドウ操作** | |
| ウィンドウ移動（左/下/上/右） | `Shift+h/j/k/l` |
| **タブ操作** | |
| 次のタブ / 前のタブ | `Tab` / `Shift+Tab` |
| 新規タブ / タブを閉じる | `,tn` / `,tc` |
| **ファイル操作** | |
| ファイルツリー表示 | `Ctrl+n` |
| プロジェクト検索 | `:Ack {パターン}` |
| 一括置換 | `:Acks /{old}/{new}/` |
| **編集操作** | |
| コメント切替（1行） | `gcc` |
| コメント切替（選択範囲） | `gc` |
| 行を上下に移動 | `Alt+j` / `Alt+k` |
| コードフォーマット | `,f` |
| **タグジャンプ（ctags）** | |
| 定義へジャンプ | `Ctrl+]` |
| ジャンプ前に戻る | `Ctrl+t` |
| タグ候補一覧 | `:ts {名前}` |

---

## 次のステップ

この演習を終えたら、以下のトピックにも挑戦してみましょう:

1. **マクロ記録:** `q{レジスタ名}` で操作を記録し、`@{レジスタ名}` で再生する
2. **レジスタ活用:** `"ayy` で `a` レジスタにヤンク、`"ap` で貼り付け
3. **Vista（タグバー）:** `,tv` または `F8` でコードの構造を一覧表示する
4. **Ferret 応用:** `:Ack` と `:Acks` を組み合わせた大規模なリファクタリング
5. **R / Fortran 開発:** 各言語専用のキーマップや機能を試す

操作に困ったら `:help {トピック}` で Vim のヘルプを参照してください。
